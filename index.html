<html>
<head>
    <meta charset="UTF-8">
    <title>视差滚动器 - 中文</title>
    <style>
        * { margin: 0; padding: 0; }
        body { background-color: #000000; }
        canvas { background-color: #222222; }
    </style>
</head>
<body onload="init()">

    <div align="center">
        <canvas id="game-canvas" width="512" height="384"></canvas>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.5.0/pixi.min.js"></script>

    <script>
    class Far extends PIXI.extras.TilingSprite {
        static DELTA_X = 0.128
        constructor(texture, width, height) {
            super(PIXI.Texture.fromImage('resources/bg-far.png'), 512, 256)

            this.position.x = 0
            this.position.y = 0
            this.tilePosition.x = 0
            this.tilePosition.y = 0

            this.viewportX = 0
        }
        // update() {
        //     this.tilePosition.x -= 0.128
        // }
        setViewportX(newX) {
            var distanceTravelled = newX - this.viewportX
            this.viewportX = newX
            this.tilePosition.x -= (distanceTravelled * Far.DELTA_X)
        }
    }
    class Mid extends PIXI.extras.TilingSprite {
        static DELTA_X = 0.64
        constructor(texture, width, height) {
            super(PIXI.Texture.fromImage('resources/bg-mid.png'), 512, 256)
            
            this.position.x = 0
            this.position.y = 128;
            this.tilePosition.x = 0
            this.tilePosition.y = 0

            this.viewportX = 0
        }
        // update() {
        //     this.tilePosition.x -= 0.64;
        // }
        setViewportX(newX) {
            var distanceTravelled = newX - this.viewportX
            this.viewportX = newX
            this.tilePosition.x -= (distanceTravelled * Mid.DELTA_X)
        }
    }    

    class Scroller {
        constructor(stage) {
            this.far = new Far()
            stage.addChild(this.far)

            this.mid = new Mid()
            stage.addChild(this.mid)

            this.viewportX = 0
        }
        // update() {
        //     this.far.update()
        //     this.mid.update()
        // }
        setViewportX(x) {
            this.viewportX = x
            this.far.setViewportX(x)
            this.mid.setViewportX(x)
        }
        getViewportX() {
            return this.viewportX
        }
        moveViewportBy(units) {
            var newViewportX = this.viewportX + units
            this.setViewportX(newViewportX)
        }
    }

    class Main {
        static SCROLL_SPEED = 5
        constructor() {
            this.stage = new PIXI.Container()
            this.renderer = PIXI.autoDetectRenderer(512, 384,
                { view: document.getElementById('game-canvas') }
            )

            this.scroller = new Scroller(this.stage)

            requestAnimationFrame(this.update.bind(this))
        }
        update() {
            this.scroller.moveViewportBy(Main.SCROLL_SPEED)
            this.renderer.render(this.stage)
            requestAnimationFrame(this.update.bind(this))
        }
    }

    function init() {
        main = new Main()
    }
    </script>

</body>
</html>
